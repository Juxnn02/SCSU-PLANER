<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SCSU | Open House Event Builder (Advanced)</title>
    <style type="text/css">/*<![CDATA[*/:root{
    --scsu-blue:#003366;
    --scsu-gold:#FFD700;
    --ink:#0f172a;
    --muted:#64748b;
    --bg:#f6f8fb;
    --card:#ffffff;
    --border:#e5e7eb;
    --shadow:rgba(0,0,0,.08);
    --ok:#065f46; --ok-bg:#ecfdf5; --ok-br:#a7f3d0;
    --warn:#92400e; --warn-bg:#fffbeb; --warn-br:#fde68a;
    --err:#991b1b; --err-bg:#fef2f2; --err-br:#fecaca;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--ink)}
  a{color:var(--scsu-blue)}
  .wrap{max-width:1100px;margin:18px auto;padding:12px}

  /* Header / hero */
  .hero{background:linear-gradient(180deg,#fff,#f9fafb);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px var(--shadow);padding:16px}
  .brand{display:flex;align-items:center;gap:12px}
  .dot{width:12px;height:12px;border-radius:999px;background:var(--scsu-gold);box-shadow:0 0 0 4px rgba(255,215,0,.22)}
  .hero h1{margin:0;font-size:22px;color:var(--scsu-blue)}
  .hero p{margin:4px 0 12px;color:#334155}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--scsu-blue);background:var(--scsu-blue);color:#fff;padding:9px 12px;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer;transition:.18s transform}
  .btn:hover{transform:translateY(-1px)}
  .btn.secondary{background:#fff;color:var(--scsu-blue)}
  .btn.ghost{background:#fff;border-color:#cbd5e1;color:#0f172a}
  .btn.warn{background:#fff;color:#92400e;border-color:#f59e0b}
  .btn.small{padding:6px 9px;font-weight:600}
  .grid{display:grid;gap:12px;margin-top:12px}
  @media(min-width:980px){.grid{grid-template-columns:1.25fr .75fr}}

  /* Panels */
  .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  .panel h2{margin:0 0 8px;font-size:16px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid #cbd5e1;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
  .chip.active{border-color:var(--scsu-blue);box-shadow:0 0 0 2px rgba(0,51,102,.08)}
  .field{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .input{border:1px solid #d1d5db;border-radius:10px;padding:8px 10px;font-size:13px;background:#fff;min-width:160px}
  .select{border:1px solid #d1d5db;border-radius:10px;padding:8px 10px;font-size:13px;background:#fff}
  .switch{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:#334155}
  .switch input{accent-color:var(--scsu-blue)}

  /* Cards & Lists */
  .list{display:grid;gap:10px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:6px}
  .card h3{margin:0;font-size:14px}
  .meta{font-size:12px;color:#475569}
  .tags{display:flex;flex-wrap:wrap;gap:6px}
  .tag{font-size:11px;border:1px solid #e2e8f0;padding:3px 6px;border-radius:999px;color:#334155;background:#fafafa}
  .badge{font-size:11px;border-radius:6px;padding:3px 6px}
  .cap{background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
  .dense{display:grid;gap:6px}
  .legend{display:flex;gap:8px;flex-wrap:wrap;font-size:11px;color:#334155;margin:6px 0}
  .legend .swatch{width:10px;height:10px;border-radius:2px;background:#cbd5e1;display:inline-block;margin-right:4px}
  .s1{background:#fee2e2}.s2{background:#e0f2fe}.s3{background:#dcfce7}.s4{background:#fef3c7}.s5{background:#ede9fe}

  /* Itinerary */
  .itinerary{display:grid;gap:10px;max-height:64vh;overflow:auto}
  .empty{border:1px dashed #cbd5e1;border-radius:12px;padding:14px;color:#64748b;background:#fafafa}
  .note{font-size:12px;color:#475569}
  .success{color:var(--ok);background:var(--ok-bg);border:1px solid var(--ok-br);border-radius:10px;padding:8px 10px;font-size:12px}
  .warn{color:var(--warn);background:var(--warn-bg);border:1px solid var(--warn-br);border-radius:10px;padding:8px 10px;font-size:12px}
  .error{color:var(--err);background:var(--err-bg);border:1px solid var(--err-br);border-radius:10px;padding:8px 10px;font-size:12px}

  /* Drag hint */
  .drag{cursor:grab}
  .drag:active{cursor:grabbing}

  /* Toast */
  .toast{position:fixed;right:16px;bottom:16px;background:#0f172a;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.2);font-size:13px;display:none;z-index:99}

  /* Print */
  @media print{
    .hero,.toolbar,.filters,.searchbar,.toast{display:none !important}
    .wrap{max-width:100%;margin:0}
    .panel{box-shadow:none;border-color:#ddd}
    body{background:#fff}
  }
    
    
    
    
    
    
    /*]]>*/
    </style>
  </head>
  <body>
    <div class="wrap">
      <!-- HERO -->
      <div class="hero">
        <div class="brand">
          <div class="dot">
          </div>

          <div>
            <div style="font-size:12px;font-weight:700;color:#0f172a">
              Southern Connecticut State University
            </div>

            <h1>
              Undergraduate Open House ‚Äî Event Builder
            </h1>
          </div>
        </div>

        <p>
          Build a personalized plan for <b>Saturday, November 8, 2025</b>. Choose preferences, curated tracks, or browse all. The builder checks time conflicts and seat availability‚Äîand remembers your plan.
        </p>

        <div class="toolbar">
          <button class="btn" id="btnBuild">üß≠ Build from preferences</button><button class="btn secondary" id="btnTracks">üéØ Curated tracks</button><button class="btn ghost" id="btnManageTracks">‚öôÔ∏è Manage tracks</button><button class="btn ghost" id="btnBrowse">üìã View all sessions</button><button class="btn ghost" id="btnImport">‚¨áÔ∏è Import plan code</button>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT -->
        <div class="left">
          <!-- BUILD -->
          <div class="panel" hidden="" id="panelBuild">
            <h2>
              Preferences
            </h2>

            <div class="filters">
              <div style="font-size:12px;color:#334155;margin:6px 0">
                Interests
              </div>

              <div class="chips" id="chipsInterests">
              </div>

              <div class="row" style="margin-top:8px">
                <div style="font-size:12px;color:#334155">
                  Session Types
                </div>

                <div class="chips" id="chipsTypes">
                </div>
              </div>

              <div class="row" style="margin-top:8px">
                <div class="chips" id="chipsTime">
                  <div class="chip" data-value="morning">
                    Morning (before 12pm)
                  </div>

                  <div class="chip" data-value="afternoon">
                    Afternoon (12‚Äì3pm)
                  </div>

                  <div class="chip" data-value="full">
                    Full Day
                  </div>
                </div>

                <div>
                  <select class="select" id="sortMode"><option value="smart">Sort: Smart</option><option value="time">Sort: Time</option><option value="pop">Sort: Capacity (fewest seats)</option></select>
                </div>
              </div>

              <div class="field">
                <input class="input" id="search" placeholder="Search sessions (title, location, tags)..." /><button class="btn small" id="btnSuggest">‚ú® Suggest</button><button class="btn ghost small" id="btnClearFilters">Reset</button>
              </div>
            </div>

            <div class="list" id="suggestions">
            </div>
          </div>
          <!-- TRACKS -->

          <div class="panel" hidden="" id="panelTracks">
            <h2>
              Curated Experience Tracks
            </h2>

            <p class="note">
              Pick a track, then tweak. Tracks avoid overlaps and include consistent pacing.
            </p>

            <div class="list" id="tracksList">
            </div>
          </div>
          <!-- MANAGE TRACKS -->

          <div class="panel" hidden="" id="panelManageTracks">
            <h2>
              Manage Curated Tracks
            </h2>

            <p class="note">
              Create custom tracks or edit existing ones.
            </p>

            <div class="field">
              <input class="input" id="newTrackName" placeholder="Track name (e.g., 'Tech Track')..." />
              <button class="btn small" id="btnAddTrack">+ Add track</button>
            </div>

            <div class="list" id="manageTracksList">
            </div>
          </div>
          <!-- BROWSE -->

          <div class="panel" hidden="" id="panelBrowse">
            <h2>
              All Sessions
            </h2>

            <div class="row searchbar">
              <div class="legend">
                <span><span class="swatch s1"></span> Presentations</span><span><span class="swatch s2"></span> Student Panels</span><span><span class="swatch s3"></span> Tours</span><span><span class="swatch s4"></span> Fairs</span><span><span class="swatch s5"></span> Welcome / Plenary</span>
              </div>

              <div class="field">
                <input class="input" id="searchAll" placeholder="Quick filter..." /><select class="select" id="sortAll"><option value="time">Sort: Time</option><option value="name">Sort: Name</option><option value="seats">Sort: Seats left</option></select>
              </div>
            </div>

            <div class="list" id="browseList">
            </div>
          </div>
        </div>
        <!-- RIGHT -->

        <div class="right">
          <div class="panel">
            <div class="row">
              <h2>
                My Itinerary <span class="badge cap" id="countPill">0</span>
              </h2>

              <div class="toolbar">
                <button class="btn ghost small" id="btnSave">üíæ Save</button><button class="btn ghost small" id="btnShare">üîó Share code</button><button class="btn ghost small" id="btnPrint">üñ®Ô∏è Print</button><button class="btn secondary small" id="btnExport">üìÖ Export .ics</button><button class="btn warn small" id="btnClearPlan">Clear</button>
              </div>
            </div>

            <div class="note">
              Drag items to reorder (we'll warn if times are out of order).
            </div>

            <div class="itinerary" id="itinerary">
              <div class="empty">
                No sessions yet. Add from suggestions, tracks, or the full list.
              </div>
            </div>

            <div class="dense" id="warnings" style="margin-top:8px">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">
    </div>
    <script>/*<![CDATA[*//** ==================== CONFIG / DATA ==================== **/
const EVENT_NAME = "Undergraduate Open House 2025";
const EVENT_DATE = "2025-11-08";
const TZID = "America/New_York";

function t(h,m){ return new Date(`${EVENT_DATE}T${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`); }

const ALL_INTERESTS = ["General","Business","Education","Health","STEM","Arts","Campus Life","Admissions"];
const ALL_TYPES = ["welcome","presentation","panel","tour","fair"];

/* Session data with capacity */
const SESSIONS = [
  {id:"welcome", title:"Welcome Session (President's Address + Student Performance)", location:"Lyman Center", start:t(9,30), end:t(10,10), type:"welcome", interests:["General","Campus Life","Admissions"], capacity:900, seats:900},
  {id:"nursing", title:"School of Nursing Presentation", location:"Lyman Center", start:t(10,30), end:t(11,0), type:"presentation", interests:["Health"], capacity:600, seats:480},
  {id:"finAid", title:"Financial Aid 101", location:"Adanti Theater", start:t(11,15), end:t(11,45), type:"presentation", interests:["Admissions"], capacity:220, seats:140},
  {id:"businessInfo", title:"School of Business Information Session", location:"School of Business", start:t(11,15), end:t(11,45), type:"presentation", interests:["Business"], capacity:140, seats:92},
  {id:"academicFair", title:"Academic & Student Services Fair", location:"ASC Ballroom", start:t(12,0), end:t(13,0), type:"fair", interests:["General","Campus Life"], capacity:800, seats:800},
  {id:"studentPanel", title:"Student Panel: Life at Southern", location:"Adanti Theater", start:t(13,0), end:t(13,30), type:"panel", interests:["Campus Life"], capacity:220, seats:208},
  {id:"campusTour", title:"Campus Tour (departures every 30 mins)", location:"ASC Lobby", start:t(12,30), end:t(13,30), type:"tour", interests:["General","Campus Life"], capacity:60, seats:40},
  {id:"hhsTour", title:"Health & Human Services Building Tour", location:"CHHS Building", start:t(13,30), end:t(14,0), type:"tour", interests:["Health"], capacity:40, seats:28},
  {id:"educationMeet", title:"Education Faculty Meet & Explore", location:"ASC Ballroom", start:t(12,30), end:t(13,0), type:"presentation", interests:["Education"], capacity:100, seats:84}
];

/* Curated tracks by session id */
const TRACKS = {
  "Academic Exploration": ["welcome","nursing","academicFair","educationMeet","hhsTour"],
  "Campus Life & Involvement": ["welcome","academicFair","studentPanel","campusTour"],
  "Admissions & Financial Aid": ["welcome","finAid","academicFair","campusTour"],
  "Student Support & Wellness": ["welcome","academicFair","hhsTour","studentPanel"]
};

/** ==================== STATE ==================== **/
let itinerary = [];                 // selected sessions
let customTracks = {};              // user-created tracks
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const toast = $('#toast');

/** ==================== INIT ==================== **/
const chipsInterests = $('#chipsInterests'), chipsTypes = $('#chipsTypes'), chipsTime = $('#chipsTime');

function makeChips(container, list){
  container.innerHTML = '';
  list.forEach(v=>{
    const d = document.createElement('div');
    d.className = 'chip'; d.dataset.value = v; d.textContent = v;
    d.onclick = ()=> d.classList.toggle('active');
    container.appendChild(d);
  });
}
makeChips(chipsInterests, ALL_INTERESTS);
makeChips(chipsTypes, ["Presentation","Panel","Tour","Fair","Welcome"]);
chipsTime.querySelectorAll('.chip').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    chipsTime.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    ch.classList.add('active');
  });
});

$('#btnBuild').onclick = ()=>showPanel('build');
$('#btnTracks').onclick= ()=>showPanel('tracks');
$('#btnManageTracks').onclick= ()=>showPanel('manageTracks');
$('#btnBrowse').onclick= ()=>showPanel('browse');
$('#btnSuggest').onclick= suggestFromFilters;
$('#btnClearFilters').onclick= clearFilters;
$('#btnAddTrack').onclick = addNewTrack;
$('#btnPrint').onclick  = ()=>window.print();
$('#btnClearPlan').onclick = ()=>{ itinerary = []; savePlan(); renderItinerary(); pop('Cleared your plan.'); };
$('#btnExport').onclick = exportICS;
$('#btnSave').onclick = ()=>{ savePlan(); pop('Saved to this browser.'); };
$('#btnShare').onclick = shareCode;
$('#btnImport').onclick = importCodePrompt;

$('#search').addEventListener('input', suggestFromFilters);
$('#sortMode').addEventListener('change', suggestFromFilters);
$('#searchAll').addEventListener('input', renderBrowse);
$('#sortAll').addEventListener('change', renderBrowse);

showPanel('build');
renderTracks();
renderBrowse();
restorePlan();
loadCustomTracks();

/** ==================== PANELS ==================== **/
function showPanel(which){
  $('#panelBuild').hidden  = which!=='build';
  $('#panelTracks').hidden = which!=='tracks';
  $('#panelManageTracks').hidden = which!=='manageTracks';
  $('#panelBrowse').hidden = which!=='browse';
}

/** ==================== RENDER HELPERS ==================== **/
function tagType(t){
  const color = {presentation:'s1', panel:'s2', tour:'s3', fair:'s4', welcome:'s5'}[t]||'';
  return `<span class="tag"><span class="swatch ${color}" style="margin-right:6px"></span>${pretty(t)}</span>`;
}
function pretty(s){ return s.replace(/(^|\s)\S/g,m=>m.toUpperCase()); }
function fmtTime(d){ return d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}); }
function minsBetween(a,b){
  return Math.round((b - a)/60000);
}
function availabilityBadge(s){
  const left = s.seats;
  let txt = `${left} seats left`;
  if(left<=0) return `<span class="badge error">Waitlist only</span>`;
  if(left<=10) return `<span class="badge warn">${txt}</span>`;
  return `<span class="badge cap">${txt}</span>`;
}

/** Card creation **/
function cardForSession(s, showAdd=true){
  const wrap = document.createElement('div');
  wrap.className = 'card';
  wrap.innerHTML = `
    <h3>${s.title}</h3>
    <div class="meta">üïí ${fmtTime(s.start)}‚Äì${fmtTime(s.end)} ‚Ä¢ üìç ${s.location}</div>
    <div class="tags">
      ${tagType(s.type)}
      ${s.interests.map(i=>`<span class="tag">${i}</span>`).join('')}
      ${availabilityBadge(s)}
    </div>
  `;
  const row = document.createElement('div');
  row.className = 'row';
  row.innerHTML = `<span class="note">ID: ${s.id}</span>`;
  const act = document.createElement('div');
  act.className = 'toolbar';
  if(showAdd){
    const btn = document.createElement('button');
    btn.className = 'btn secondary small'; btn.textContent = 'Add';
    btn.onclick = ()=> tryAddSession(s);
    act.appendChild(btn);
  }
  row.appendChild(act);
  wrap.appendChild(row);
  return wrap;
}

/** ==================== BROWSE ==================== **/
function renderBrowse(){
  const list = $('#browseList');
  const q = ($('#searchAll').value||'').toLowerCase();
  const mode = $('#sortAll').value;
  let items = SESSIONS.slice();
  if(q){
    items = items.filter(s =>
      s.title.toLowerCase().includes(q) ||
      s.location.toLowerCase().includes(q) ||
      s.interests.join(' ').toLowerCase().includes(q)
    );
  }
  if(mode==='time') items.sort((a,b)=>a.start-b.start);
  if(mode==='name') items.sort((a,b)=>a.title.localeCompare(b.title));
  if(mode==='seats') items.sort((a,b)=>a.seats-b.seats);

  list.innerHTML = '';
  items.forEach(s=> list.appendChild(cardForSession(s, true)));
}

/** ==================== TRACKS ==================== **/
function renderTracks(){
  const host = $('#tracksList'); host.innerHTML='';
  const allTracks = {...TRACKS, ...customTracks};
  Object.entries(allTracks).forEach(([name, ids])=>{
    const div = document.createElement('div'); div.className = 'card';
    const sessions = ids.map(id=>SESSIONS.find(s=>s.id===id)).filter(Boolean).sort((a,b)=>a.start-b.start);
    const isCustom = customTracks.hasOwnProperty(name);
    div.innerHTML = `
      <h3>üéØ ${name}${isCustom?' (Custom)':''}</h3>
      <div class="list"></div>
      <div class="row">
        <span class="note">${sessions.length} sessions</span>
        <div class="toolbar"><button class="btn secondary small">Load track</button></div>
      </div>
    `;
    const inner = div.querySelector('.list');
    if(sessions.length){
      sessions.forEach(s=> inner.appendChild(cardForSession(s, false)));
    }else{
      inner.innerHTML = '<div class="empty">No sessions in this track.</div>';
    }
    div.querySelector('.btn').onclick = ()=>{
      if(!sessions.length){ pop('This track is empty.'); return; }
      itinerary = sessions.slice();
      savePlan(); renderItinerary();
      pop(`Loaded "${name}"`);
    };
    host.appendChild(div);
  });
}

/** PREFERENCES / SUGGEST ==================== **/
function getActive(container){ return Array.from(container.querySelectorAll('.chip.active')).map(d=>d.dataset.value || d.textContent); }
function suggestFromFilters(){
  const selInterests = getActive(chipsInterests);
  let selTypes = getActive(chipsTypes).map(v=>v.toLowerCase());
  selTypes = selTypes.map(v => ({presentation:'presentation',panel:'panel',tour:'tour',fair:'fair','welcome':'welcome'})[v]||v);
  const timeChip = chipsTime.querySelector('.chip.active');
  const timePref = timeChip ? timeChip.dataset.value : null;
  const q = ($('#search').value||'').toLowerCase();
  const mode = $('#sortMode').value;

  // Filter pool
  let pool = SESSIONS.slice();
  if(selInterests.length) pool = pool.filter(s => s.interests.some(i=>selInterests.includes(i)));
  if(selTypes.length) pool = pool.filter(s => selTypes.includes(s.type));
  if(timePref==='morning') pool = pool.filter(s => s.start.getHours()<12);
  if(timePref==='afternoon') pool = pool.filter(s => s.start.getHours()>=12);
  if(q) pool = pool.filter(s => s.title.toLowerCase().includes(q) || s.location.toLowerCase().includes(q) || s.interests.join(' ').toLowerCase().includes(q));

  // Score function (interest match, rare seats, earlier time, type weight)
  const score = s => (
    (selInterests.reduce((acc,i)=>acc+(s.interests.includes(i)?1:0),0) * 12) +
    (s.type==='welcome'?6:0) +
    (s.type==='tour'?3:0) +
    (Math.max(0, 30 - s.seats)/5) +           // rarer seats -> boost
    (120 - (s.start - t(0,0))/60000)/40       // earlier -> slight boost
  );
  if(mode==='smart') pool.sort((a,b)=> score(b)-score(a));
  if(mode==='time') pool.sort((a,b)=> a.start-b.start);
  if(mode==='pop') pool.sort((a,b)=> a.seats-b.seats);

  // Greedy pick without overlaps
  const picks = [];
  pool.forEach(s=>{
    if(picks.every(x=>!overlap(x,s))){
      picks.push(s);
    }
  });
  const top = picks.slice(0,6).sort((a,b)=>a.start-b.start);

  const host = $('#suggestions'); host.innerHTML='';
  if(!top.length){
    host.innerHTML = `<div class="warn">No matches. Try fewer filters or switch sort mode.</div>`;
    return;
  }
  top.forEach(s => host.appendChild(cardForSession(s, true)));
}
function clearFilters(){
  [chipsInterests, chipsTypes, chipsTime].forEach(box => box.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')));
  $('#search').value=''; $('#sortMode').value='smart';
  $('#suggestions').innerHTML = `<div class="success">Filters cleared. Click <b>Suggest</b> to refresh.</div>`;
}

/** ==================== ITINERARY ==================== **/
function overlap(a,b){ return (a.start < b.end) && (b.start < a.end); }

function tryAddSession(s){
  // capacity gate
  if(s.seats<=0){ pop('This session is at capacity ‚Äî added to waitlist not supported here.'); return; }
  // time conflict?
  const clash = itinerary.find(x=>overlap(x,s));
  if(clash){
    // Offer auto-resolve: replace the clashing one if user wants.
    const alt = findNearestAlternative(s, clash);
    let msg = `Conflict with "${clash.title}".`;
    if(alt){ msg += ` Suggested alternative: "${alt.title}" at ${fmtTime(alt.start)}.`; }
    pop(msg);
    return;
  }
  itinerary.push(s);
  s.seats = Math.max(0, s.seats - 1); // RSVP hold
  itinerary.sort((a,b)=>a.start-b.start);
  savePlan(); renderAll();
  pop(`Added: ${s.title}`);
}

function findNearestAlternative(target, conflicting){
  // Try to find same type/interest after conflict end (within 90m)
  return SESSIONS
    .filter(s => s.id!==target.id && s.type===target.type && s.interests.some(i=>target.interests.includes(i)))
    .filter(s => !itinerary.some(x=>overlap(x,s)))
    .find(s => s.start>=conflicting.end && minsBetween(conflicting.end, s.start)<=90);
}

function removeSession(id){
  const s = SESSIONS.find(x=>x.id===id);
  if(s){ s.seats += 1; } // release seat
  itinerary = itinerary.filter(s=>s.id!==id);
  savePlan(); renderAll();
}

/* Drag to reorder (visual only; will warn if chrono order broken) */
let dragSrcIdx = null;
function enableDrag(){
  $$('#itinerary .card').forEach((el, idx)=>{
    el.draggable = true; el.classList.add('drag');
    el.ondragstart = (e)=>{ dragSrcIdx = idx; e.dataTransfer.effectAllowed='move'; };
    el.ondragover  = (e)=>{ e.preventDefault(); };
    el.ondrop      = (e)=>{
      e.preventDefault();
      const destIdx = idx;
      if(dragSrcIdx===null || dragSrcIdx===destIdx) return;
      const arr = itinerary.slice();
      const [moved] = arr.splice(dragSrcIdx,1);
      arr.splice(destIdx,0,moved);
      itinerary = arr;
      savePlan(); renderItinerary(); pop('Reordered.');
    };
  });
}

function renderItinerary(){
  $('#countPill').textContent = itinerary.length;
  const host = $('#itinerary'); host.innerHTML='';
  if(!itinerary.length){
    host.innerHTML = `<div class="empty">No sessions yet. Add from suggestions, tracks, or the full list.</div>`;
    $('#warnings').innerHTML='';
    return;
  }
  itinerary.forEach(s=>{
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <h3>${s.title}</h3>
      <div class="meta">üïí ${fmtTime(s.start)}‚Äì${fmtTime(s.end)} ‚Ä¢ üìç ${s.location}</div>
      <div class="tags">
        ${tagType(s.type)}
        ${s.interests.map(i=>`<span class="tag">${i}</span>`).join('')}
      </div>
      <div class="row">
        <span class="note">ID: ${s.id}</span>
        <div class="toolbar">
          <button class="btn ghost small" onclick="removeSession('${s.id}')">Remove</button>
        </div>
      </div>
    `;
    host.appendChild(card);
  });
  enableDrag();
  renderWarnings();
}

/** Order warnings */
function renderWarnings(){
  const wrap = $('#warnings'); wrap.innerHTML='';
  // chronological order check
  const chrono = itinerary.slice().sort((a,b)=>a.start-b.start);
  const outOfOrder = itinerary.some((s,i)=> s.id!==chrono[i]?.id);
  if(outOfOrder){
    wrap.innerHTML += `<div class="warn">Itinerary is out of chronological order (due to manual drag). Export/print will still sort by time.</div>`;
  }
}

/** ==================== CUSTOM TRACKS ==================== **/
function loadCustomTracks(){
  const raw = localStorage.getItem('scsu_custom_tracks');
  if(raw){
    try{ customTracks = JSON.parse(raw); }catch{}
  }
  renderManageTracks();
}
function saveCustomTracks(){
  localStorage.setItem('scsu_custom_tracks', JSON.stringify(customTracks));
}
function addNewTrack(){
  const name = $('#newTrackName').value.trim();
  if(!name){ pop('Enter a track name.'); return; }
  if(customTracks[name]){ pop('Track already exists.'); return; }
  customTracks[name] = [];
  $('#newTrackName').value='';
  saveCustomTracks();
  renderManageTracks();
  renderTracks();
  pop(`Created track: "${name}"`);
}
function deleteTrack(name){
  if(confirm(`Delete track "${name}"?`)){
    delete customTracks[name];
    saveCustomTracks();
    renderManageTracks();
    renderTracks();
    pop(`Deleted track.`);
  }
}
function addSessionToTrack(trackName, sessionId){
  if(!customTracks[trackName]) return;
  if(!customTracks[trackName].includes(sessionId)){
    customTracks[trackName].push(sessionId);
    saveCustomTracks();
    renderManageTracks();
    pop(`Added to "${trackName}".`);
  }
}
function removeSessionFromTrack(trackName, sessionId){
  if(!customTracks[trackName]) return;
  customTracks[trackName] = customTracks[trackName].filter(id=>id!==sessionId);
  saveCustomTracks();
  renderManageTracks();
}
function renderManageTracks(){
  const host = $('#manageTracksList'); host.innerHTML='';
  const allNames = [...Object.keys(TRACKS), ...Object.keys(customTracks)];
  allNames.forEach(name=>{
    const isCustom = customTracks.hasOwnProperty(name);
    const ids = isCustom ? customTracks[name] : TRACKS[name];
    const sessions = ids.map(id=>SESSIONS.find(s=>s.id===id)).filter(Boolean).sort((a,b)=>a.start-b.start);
    
    const div = document.createElement('div'); div.className = 'card';
    const header = document.createElement('div'); header.className='row';
    header.innerHTML = `<h3>${name}${isCustom?' (Custom)':''}</h3>`;
    const actions = document.createElement('div'); actions.className='toolbar';
    if(isCustom){
      const btn = document.createElement('button');
      btn.className = 'btn warn small'; btn.textContent = 'Delete';
      btn.onclick = ()=> deleteTrack(name);
      actions.appendChild(btn);
    }
    header.appendChild(actions);
    div.appendChild(header);
    
    const list = document.createElement('div'); list.className='list';
    sessions.forEach(s=>{
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `
        <h3>${s.title}</h3>
        <div class="meta">üïí ${fmtTime(s.start)}‚Äì${fmtTime(s.end)} ‚Ä¢ üìç ${s.location}</div>
      `;
      if(isCustom){
        const row = document.createElement('div'); row.className='row';
        const btn = document.createElement('button');
        btn.className = 'btn ghost small'; btn.textContent = 'Remove from track';
        btn.onclick = ()=> removeSessionFromTrack(name, s.id);
        row.appendChild(btn);
        card.appendChild(row);
      }
      list.appendChild(card);
    });
    const addBtn = document.createElement('div'); addBtn.className='field';
    addBtn.innerHTML = `
      <select class="select" id="trackAdd_${name}" style="flex:1">
        <option value="">+ Add session to track...</option>
        ${SESSIONS.map(s=>`<option value="${s.id}">${s.title}</option>`).join('')}
      </select>
    `;
    addBtn.querySelector('select').onchange = (e)=>{
      if(e.target.value){
        addSessionToTrack(name, e.target.value);
        e.target.value='';
      }
    };
    list.appendChild(addBtn);
    div.appendChild(list);
    host.appendChild(div);
  });
}

/** ==================== SAVE / SHARE ==================== **/
function savePlan(){
  const ids = itinerary.map(s=>s.id);
  localStorage.setItem('scsu_openhouse_plan', JSON.stringify(ids));
}
function restorePlan(){
  const raw = localStorage.getItem('scsu_openhouse_plan');
  if(!raw) return;
  try{
    const ids = JSON.parse(raw);
    itinerary = ids.map(id=>SESSIONS.find(s=>s.id===id)).filter(Boolean);
    renderAll();
    pop('Restored your saved plan.');
  }catch{}
}
function shareCode(){
  const payload = {
    v:1,
    date:EVENT_DATE,
    ids: itinerary.map(s=>s.id)
  };
  const code = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
  navigator.clipboard?.writeText(code);
  pop('Share code copied to clipboard.');
}
function importCodePrompt(){
  const code = prompt('Paste your share code:');
  if(!code) return;
  try{
    const payload = JSON.parse(decodeURIComponent(escape(atob(code))));
    if(payload?.ids?.length){
      itinerary = payload.ids.map(id=>SESSIONS.find(s=>s.id===id)).filter(Boolean);
      renderAll();
      pop('Imported plan from code.');
    }else{
      pop('Invalid code.');
    }
  }catch{ pop('Invalid code.'); }
}

/** ==================== EXPORT .ICS ==================== **/
function toICSDate(dt){
  const pad = n=>String(n).padStart(2,'0');
  return `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}T${pad(dt.getHours())}${pad(dt.getMinutes())}${pad(dt.getSeconds())}`;
}
function exportICS(){
  if(!itinerary.length){ pop('Add at least one session.'); return; }
  const lines = [
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//SCSU//EventBuilder//EN','CALSCALE:GREGORIAN',`X-WR-CALNAME:${EVENT_NAME}`
  ];
  itinerary.slice().sort((a,b)=>a.start-b.start).forEach(s=>{
    lines.push('BEGIN:VEVENT');
    lines.push(`UID:${s.id}-${Date.now()}@scsu`);
    lines.push(`SUMMARY:${s.title}`);
    lines.push(`LOCATION:${s.location}`);
    lines.push(`DESCRIPTION:Southern Connecticut State University ‚Äî ${EVENT_NAME}`);
    lines.push(`DTSTART;TZID=${TZID}:${toICSDate(s.start)}`);
    lines.push(`DTEND;TZID=${TZID}:${toICSDate(s.end)}`);
    lines.push('END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const blob = new Blob([lines.join('\r\n')], {type:'text/calendar'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='SCSU-OpenHouse-Plan.ics'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 3000);
}

/** ==================== UTIL ==================== **/
function pop(msg){
  toast.textContent = msg; toast.style.display='block';
  clearTimeout(pop._t); pop._t = setTimeout(()=>toast.style.display='none', 2200);
}
function renderAll(){ renderItinerary(); renderBrowse(); }

/** ==================== INITIAL SUGGESTIONS ==================== **/
suggestFromFilters();/*]]>*/</script>
  </body>
</html>
